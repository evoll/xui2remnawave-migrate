#!/bin/bash
# ==========================================================
# üß© –ê–≤—Ç–æ—É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ xui2remnawave-migrate (3x-UI ‚Üí Remnawave)
# ==========================================================

set -e

REPO_URL="https://github.com/evoll/xui2remnawave-migrate.git"
INSTALL_DIR="$HOME/xui2remnawave-migrate"

echo "==============================================="
echo " üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ xui2remnawave-migrate "
echo "==============================================="

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ Git ---
if ! command -v git &> /dev/null; then
    echo "‚ùå Git –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –∫–æ–º–∞–Ω–¥–æ–π:"
    echo "   sudo apt install git -y"
    exit 1
fi

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ Python ---
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3.9+ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ."
    exit 1
fi

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ pip ---
if ! command -v pip3 &> /dev/null; then
    echo "‚ùå pip3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pip (python3 -m ensurepip)."
    exit 1
fi

# --- –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ---
if [ -d "$INSTALL_DIR" ]; then
    echo "‚öôÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
    rm -rf "$INSTALL_DIR"
fi

# --- –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ---
echo "üì¶ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏–∑ GitHub..."
git clone "$REPO_URL" "$INSTALL_DIR" > /dev/null 2>&1

if [ ! -d "$INSTALL_DIR" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è."
    exit 1
fi

# --- –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ---
cd "$INSTALL_DIR"

# --- –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ª–æ–≥–æ–≤ ---
mkdir -p logs

# --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ---
echo ""
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
pip3 install --upgrade pip > /dev/null
pip3 install httpx > /dev/null

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ ---
if [ -f "run.sh" ]; then
    chmod +x run.sh
else
    echo "‚ö†Ô∏è –§–∞–π–ª run.sh –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É."
fi

# --- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ---
echo ""
echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo "üìÇ –ü—É—Ç—å –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ: $INSTALL_DIR"
echo "üìò –õ–æ–≥–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤: $INSTALL_DIR/logs"
echo ""
read -p "–•–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å? (y/n): " START_NOW
if [[ "$START_NOW" == "y" || "$START_NOW" == "Y" ]]; then
    ./run.sh
else
    echo ""
    echo "üöÄ –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "cd $INSTALL_DIR && ./run.sh"
fi
